<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>3D Maze Game</title>
<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
<style>
body {
  font-family: 'VT323', monospace;
  background: #222;
  color: #fff;
  margin: 0;
  display: flex;
  justify-content: center;
  padding-top: 20px;
}

#gameContainer {
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
}

#direction {
  font-size: 28px;
  margin-bottom: 10px;
  text-align: center;
}

#canvasWrapper {
  display: flex;
  justify-content: center;
  width: 600px;
  position: relative;
}

canvas {
  border: 2px solid black;
  background: #ffffff;
  display: block;
}

#miniMapCanvas {
  border: 2px solid white;
  background: #000;
  display: none;
  position: absolute;
  top: 0;
  left: 0;
  z-index: 10;
}

#message {
  margin-top: 5px;
  font-size: 20px;
  text-align: center;
  min-height: 24px;
}

#continueBtn {
  margin-top: 5px;
  font-size: 18px;
  padding: 5px 15px;
  font-family: 'VT323', monospace;
  display: none;
  cursor: pointer;
}

#toggleMapBtn {
  margin-top: 10px;
  font-size: 16px;
  padding: 5px 10px;
  cursor: pointer;
  font-family: 'VT323', monospace;
}

/* D-Pad controls */
#controls {
  margin-top: 15px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

#controls .row {
  display: flex;
  justify-content: center;
}

#controls button {
  width: 60px;
  height: 60px;
  font-size: 24px;
  background: #444;
  color: white;
  border: 2px solid #888;
  border-radius: 0;
  margin: 1px;
  cursor: pointer;
}

#controls button.disabled {
  background: #222;
  color: #666;
  border-color: #666;
  cursor: not-allowed;
}
</style>
</head>
<body>
<div id="gameContainer">
  <div id="direction">Direction: N</div>
  <div id="canvasWrapper">
    <canvas id="gameCanvas" width="600" height="600"></canvas>
    <canvas id="miniMapCanvas" width="600" height="600"></canvas>
  </div>
  <button id="toggleMapBtn">Show Map</button>
  <div id="message"></div>
  <button id="continueBtn">Continue</button>

  <!-- D-Pad controls -->
  <div id="controls">
    <div class="row">
      <button id="btnUp">↑</button>
    </div>
    <div class="row">
      <button id="btnLeft">←</button>
      <button id="btnDown">↓</button>
      <button id="btnRight">→</button>
    </div>
  </div>
</div>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

const miniCanvas = document.getElementById("miniMapCanvas");
const miniCtx = miniCanvas.getContext("2d");

const messageDiv = document.getElementById("message");
const continueBtn = document.getElementById("continueBtn");
const directionDiv = document.getElementById("direction");
const toggleMapBtn = document.getElementById("toggleMapBtn");
const controls = document.getElementById("controls");

const dirNames = ["NORTH","EAST","SOUTH","WEST"];
const images = {};
const imgNames = [
  "back",
  "mid0","mid1","mid2","mid3","mid4",
  "left0","left1","left2","left3","left4",
  "right0","right1","right2","right3","right4",
  "player",
  "playerwin"
];
let loadedCount = 0;

imgNames.forEach(name=>{
  const img = new Image();
  img.src = name+".png";
  img.onload = ()=>{
    loadedCount++;
    if(loadedCount === imgNames.length) initGame();
  };
  images[name]=img;
});

const stepSound = new Audio("step.wav"); 
const endSound = new Audio("end.wav");   
const resetSound = new Audio("restart.wav");   

let size = 15;
let maze = [];
let playerX = 1, playerY = 1, playerDir = 0;
let endX, endY;
const dirX=[0,1,0,-1], dirY=[-1,0,1,0];
let gamePaused = false;
let currentPlayerImg = null;
let mapVisible = false;

function generateMaze(){
  maze=Array.from({length:size},()=>Array(size).fill(1));
  function carve(x,y){
    maze[y][x]=0;
    const dirs=[0,1,2,3].sort(()=>Math.random()-0.5);
    for(let d of dirs){
      const nx=x+dirX[d]*2, ny=y+dirY[d]*2;
      if(nx>0 && ny>0 && nx<size-1 && ny<size-1 && maze[ny][nx]===1){
        maze[y+dirY[d]][x+dirX[d]]=0;
        carve(nx,ny);
      }
    }
  }
  carve(1,1);
  endX=size-2; endY=size-2;
  maze[endY][endX]=2;
}

function inBounds(x,y){ return x>=0 && x<size && y>=0 && y<size; }

const exitColors = ["#ff0000","#ffff00","#00ff00","#00ffff","#0000ff","#ff00ff"];
let colorIndex = 0;

function drawWallImage(wallType, depth, isExit){
  if(isExit){
    const tempCanvas = document.createElement("canvas");
    tempCanvas.width = 600; 
    tempCanvas.height = 600;
    const tctx = tempCanvas.getContext("2d");
    tctx.drawImage(images[wallType+depth], 0, 0, 600, 600);
    tctx.globalCompositeOperation = "source-in";
    tctx.fillStyle = exitColors[colorIndex];
    tctx.fillRect(0,0,600,600);
    ctx.drawImage(tempCanvas, 0, 0);
  } else {
    ctx.drawImage(images[wallType+depth], 0, 0, 600, 600);
  }
}

setInterval(()=>{
  colorIndex = (colorIndex+1) % exitColors.length;
  drawScene();
}, 1000);

function drawScene(){
  ctx.clearRect(0,0,600,600);
  ctx.drawImage(images["back"],0,0,600,600);
  const MAX_DEPTH=4;
  const dm=(playerDir===1||playerDir===3)?-1:1;
  for(let l=MAX_DEPTH;l>=0;l--){
    const x=playerX+l*dirX[playerDir];
    const y=playerY+l*dirY[playerDir];
    if(!inBounds(x,y)) continue;
    const xl=x+dirY[playerDir]*dm, yl=y+dirX[playerDir]*dm;
    const xr=x-dirY[playerDir]*dm, yr=y-dirX[playerDir]*dm;
    if(inBounds(xl,yl)&&maze[yl][xl]!==0) drawWallImage("left",l,maze[yl][xl]===2);
    if(inBounds(xr,yr)&&maze[yr][xr]!==0) drawWallImage("right",l,maze[yr][xr]===2);
    if(maze[y][x]!==0) drawWallImage("mid",l,maze[y][x]===2);
  }
  ctx.drawImage(currentPlayerImg, (canvas.width-currentPlayerImg.width)/2, (canvas.height-currentPlayerImg.height)/2);

  if(mapVisible){
    miniCanvas.style.display="block";
    miniCtx.clearRect(0,0,600,600);
    const cellSize = 600/size;
    for(let yy=0; yy<size; yy++){
      for(let xx=0; xx<size; xx++){
        miniCtx.fillStyle = maze[yy][xx]===1?"black":maze[yy][xx]===2?"green":"white";
        miniCtx.fillRect(xx*cellSize,yy*cellSize,cellSize,cellSize);
      }
    }
    miniCtx.save();
    miniCtx.translate(playerX*cellSize+cellSize/2, playerY*cellSize+cellSize/2);
    miniCtx.rotate(playerDir*Math.PI/2);
    miniCtx.fillStyle="red";
    miniCtx.beginPath();
    miniCtx.moveTo(0,-cellSize/3);
    miniCtx.lineTo(cellSize/4,cellSize/4);
    miniCtx.lineTo(-cellSize/4,cellSize/4);
    miniCtx.closePath();
    miniCtx.fill();
    miniCtx.restore();
    disableControls(true);
  } else {
    miniCanvas.style.display="none";
    disableControls(false);
  }

  directionDiv.textContent = `Direction: ${dirNames[playerDir]} ${["↑","→","↓","←"][playerDir]}`;
}

function disableControls(flag){
  const btns = controls.querySelectorAll("button");
  btns.forEach(b=>{
    if(flag){
      b.classList.add("disabled");
      b.disabled = true;
    } else {
      b.classList.remove("disabled");
      b.disabled = false;
    }
  });
}

function restartGame(){
  playerX=1; playerY=1; playerDir=0;
  gamePaused=false;
  mapVisible=false;
  currentPlayerImg=images["player"];
  continueBtn.style.display="none";
  messageDiv.textContent="";
  toggleMapBtn.disabled = false;
  generateMaze();
  drawScene();
}

function handleMove(key){
  if(gamePaused || mapVisible) return;
  let newX=playerX,newY=playerY;
  if(key==="ArrowUp"){ newX+=dirX[playerDir]; newY+=dirY[playerDir]; }
  if(key==="ArrowDown"){ newX-=dirX[playerDir]; newY-=dirY[playerDir]; }
  if(inBounds(newX,newY)&&maze[newY][newX]!==1){
    playerX=newX; playerY=newY;
    if(key==="ArrowUp"||key==="ArrowDown"){
      stepSound.currentTime=0;
      stepSound.play();
    }
  }
  if(key==="ArrowLeft"){ playerDir=(playerDir+3)%4; }
  if(key==="ArrowRight"){ playerDir=(playerDir+1)%4; }
  drawScene();
  if(playerX===endX && playerY===endY){
    messageDiv.textContent = "CONGRATULATIONS! YOU FOUND THE EXIT!";
    continueBtn.style.display="inline-block";
    gamePaused = true;
    currentPlayerImg = images["playerwin"];
    endSound.currentTime = 0;
    endSound.play();
    toggleMapBtn.disabled = true; // disable map button after winning
    drawScene();
  }
}

function initGame(){
  generateMaze();
  currentPlayerImg=images["player"];
  drawScene();

  document.addEventListener("keydown", e=>{
    if(e.repeat) return;
    handleMove(e.key);
  });

  document.getElementById("btnUp").addEventListener("click", ()=>handleMove("ArrowUp"));
  document.getElementById("btnDown").addEventListener("click", ()=>handleMove("ArrowDown"));
  document.getElementById("btnLeft").addEventListener("click", ()=>handleMove("ArrowLeft"));
  document.getElementById("btnRight").addEventListener("click", ()=>handleMove("ArrowRight"));

  continueBtn.addEventListener("click", ()=>{
    restartGame();
    resetSound.currentTime = 0;
    resetSound.play();
  });

  toggleMapBtn.addEventListener("click", ()=>{
    if(toggleMapBtn.disabled) return;
    mapVisible = !mapVisible;
    toggleMapBtn.textContent = mapVisible ? "Hide Map" : "Show Map";
    drawScene();
  });
}
</script>
</body>
</html>
